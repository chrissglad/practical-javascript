<!DOCTYPE html>

<html>
  <head>
    <title>Practical JavaScript</title>
  </head>

  <body>
    <script src="babel-standalone.js"></script>
    <script src="uuid.js"></script>
    <script type="text/babel">
      const LOCAL_STORAGE_KEY = "pj_todos";

      class PJTodos {
        constructor() {
          this.useLocalStorage = typeof localStorage !== undefined;

          if (this.useLocalStorage) {
            let lsItems = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (lsItems === null) {
              this.todoMap = {
                todos: [],
              };
            } else {
              this.todoMap = JSON.parse(lsItems);
            }
            console.log(this.todoMap.todos);
          }
        }

        //add item
        addTodo(initialTodoText) {
          if (this.useLocalStorage) {
            let { todos } = this.todoMap;
            let newTodo = {
              id: uuidv4(),
              text: initialTodoText,
              isCompleted: false,
              createdAt: Date.now(),
              updatedAt: Date.now(),
            }
            todos.push(newTodo)    
            console.log(todos);
            return this.saveTodosInLocalStorage(todos);
          }
        }

        //edit item
        editTodo(id, newTodoText) {
          if (this.useLocalStorage) {
            let { todos } = this.todoMap;
            let todoIndex = todos.findIndex(todo => todo.id === id)
            todos[todoIndex] = Object.assign({}, todos[todoIndex], {text: newTodoText, updatedAt: Date.now()})
            console.log(todos);
            return this.saveTodosInLocalStorage(todos);
          }
        }

        //remove item
        removeTodo(id) {
          if (this.useLocalStorage) {
            let { todos } = this.todoMap;
            let todoIndex = todos.findIndex(todo => todo.id === id)
            todos.splice(todoIndex, 1)
            console.log(todos);
            return this.saveTodosInLocalStorage(todos);
          }
        }

        // clear items
        clearTodos() {
          if (this.useLocalStorage) {
            if (localStorage.getItem(LOCAL_STORAGE_KEY) !== null)
              return localStorage.removeItem(LOCAL_STORAGE_KEY);
          }
        }

        // save todos to localstorage
        saveTodosInLocalStorage(todos) {
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ todos }));
        }
      }

      const pjTodos = new PJTodos()

      // pjTodos.addTodo('hello world')
    </script>
  </body>
</html>
